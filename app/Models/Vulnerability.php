<?php

namespace App\Models;

use Illuminate\Database\Eloquent\Factories\HasFactory;
use Illuminate\Database\Eloquent\Model;
use Illuminate\Database\Eloquent\SoftDeletes;
use App\Models\Scopes\VulnerabilityScope;
use Illuminate\Database\Eloquent\Builder;

class Vulnerability extends Model
{
    use HasFactory,SoftDeletes;
    protected $fillable = ['id','user_id','site','title','type','poc',
    'created_at','updated_at','deleted_at','step_for_reduce','report'];
    
    public function user(){
        return $this->belongsTo(User::class ,'user_id','id');
    }

    protected static function booted()
    {
        static::addGlobalScope('vulnerability', new VulnerabilityScope());       
    }
    public function scopeFilter(Builder $builder, $filters)
    {
        $options = array_merge([
            'title' => null,
            'site' => null,
            'type' => null,
        ], $filters);
        $builder ->when($options['site'],function ($query,$site){
            return $query->where('site','LIKE',"%$site%");
        });
        $builder ->when($options['title'],function ($query,$title){
            return $query->where('title','LIKE',"%$title%");
        });
        if($options['type']) { 
            $builder ->when($options['type'],function ($query,$type){
                return $query->where('type','LIKE',"%$type%");
            });  
        }
    }
    // public static function rules($id=0){
    //     return [
    //         'name'=>"required|string|min:3|max:255|unique:categories,name,$id",
    //         'parent_id'=>['nullable','int','exists:categories,id'],
    //         'image'=>[
    //             'image','max:1048576','dimensions:min_width=100,min_height=100'
    //         ],
    //         'status'=>'in:active,archived'
        
    //       ];
    //   }
}
